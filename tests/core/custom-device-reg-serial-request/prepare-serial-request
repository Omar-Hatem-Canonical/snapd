#!/bin/sh

# This hook is called during the serial request preparation
# It receives the request-id and can modify the registration body

# Set the device service URL (this is done for mocking purposes)
snapctl set device-service.url=http://localhost:11029

# Set the header to use the proposed serial
snapctl set device-service.headers='{"X-Use-Proposed": "yes"}'

# Get the request-id that was set by snapd
REQUEST_ID=$(snapctl get registration.request-id)

# Create a signature/hash of the request ID to include in the body
REQUEST_ID_SIGNATURE=$(echo -n "$REQUEST_ID" | sha256sum | cut -d' ' -f1)

# Set the registration body with dynamic content based on the request-id
snapctl set registration.body="{\"hardware-id-key\": \"${KEY}\", 
                                \"hardware-id-key-sha384\": \"${HASH}\",
                                \"request-id-signature\": \"${SIGNATURE}\",
                                }"

# Set a proposed serial that will be used because of the X-Use-Proposed header
snapctl set registration.proposed-serial="7777"